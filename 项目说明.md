# 桂林理工大学南宁分校校园网自动登录服务安装程序 - 项目说明

## 📁 项目结构

```
LoginAutoSH/
├── install.sh          # 🚀 主安装脚本（一键配置）
├── uninstall.sh        # 🗑️ 卸载脚本（完整清理）
├── login.sh            # 📄 原始登录脚本（已废弃，仅供参考）
├── test.sh             # 🔧 测试工具（安装前环境检测）
├── README.md           # 📖 完整使用文档
├── QUICKSTART.md       # ⚡ 快速开始指南
└── config.example      # 📝 配置文件示例
```

## 🎯 核心功能

### ✅ 已实现
- [x] 自动检测 OpenWrt 环境
- [x] 自动安装依赖包（wget、curl）
- [x] 自动获取 WAN 口本地 DHCP IP
- [x] 交互式配置向导
- [x] 多种日志模式（文件/syslog/禁用）
- [x] 日志大小限制和自动轮转
- [x] OpenWrt 服务集成
- [x] 开机自启动
- [x] 网络断线自动重连
- [x] 测试工具（环境诊断）

### 🔄 改进点（相比原始脚本）

| 原始脚本 | 改进后 |
|---------|--------|
| 手动指定 WAN 接口 | ✅ 自动检测接口 |
| 硬编码账号密码 | ✅ 交互式输入 |
| 固定检测频率 | ✅ 可配置频率 |
| 无日志管理 | ✅ 完整日志系统 |
| 手动运行 | ✅ 系统服务 |
| 无开机启动 | ✅ 自动启动 |
| 日志无限增长 | ✅ 大小限制+轮转 |

## 🚀 快速开始

### 方案 A: 推荐方式（测试 → 安装）

```bash
# 1. 上传文件到路由器
scp install.sh test.sh root@192.168.1.1:/tmp/

# 2. 运行测试工具（可选但推荐）
ssh root@192.168.1.1
chmod +x /tmp/test.sh && /tmp/test.sh

# 3. 运行安装程序
chmod +x /tmp/install.sh && /tmp/install.sh
```

### 方案 B: 快速安装（跳过测试）

```bash
# 上传并安装
scp install.sh root@192.168.1.1:/tmp/
ssh root@192.168.1.1 "chmod +x /tmp/install.sh && /tmp/install.sh"
```

## 📋 安装流程

运行 `install.sh` 后，按提示依次输入：

1. **WAN 接口** - 自动检测，通常直接回车
2. **登录账号** - 你的学号/工号
3. **登录密码** - 对应密码
4. **运营商** - 1（联通）或 2（移动）
5. **检测频率** - 推荐 30000（30秒）
6. **日志方式** - 推荐选 1（文件日志）
7. **日志大小** - 推荐 10 MB

完成后自动启动服务并设置开机自启。

## 📊 配置选项详解

### 检测频率建议

| 场景 | 频率 | 说明 |
|-----|------|------|
| 宿舍有线网络 | 60000 ms (60秒) | 稳定，低负载 |
| 普通校园网 | 30000 ms (30秒) | 平衡性能 ⭐ 推荐 |
| 移动热点/不稳定 | 10000 ms (10秒) | 快速重连 |

### 日志方式对比

| 方式 | 优点 | 缺点 | 适用场景 |
|-----|------|------|---------|
| **文件日志** | 独立文件，便于查看 | 占用存储 | 存储充足 ⭐ 推荐 |
| **Syslog** | 不占额外空间 | 需用命令查看 | 存储紧张 |
| **禁用** | 零开销 | 无法排查问题 | 性能敏感 |

## 🛠️ 常用命令

```bash
# 服务管理
/etc/init.d/autologin start      # 启动
/etc/init.d/autologin stop       # 停止
/etc/init.d/autologin restart    # 重启
/etc/init.d/autologin status     # 状态

# 日志查看（文件模式）
tail -f /usr/local/autologin/logs/autologin.log      # 实时
tail -n 50 /usr/local/autologin/logs/autologin.log   # 最近50行

# 日志查看（syslog 模式）
logread -f | grep autologin      # 实时
logread | grep autologin         # 历史

# 配置修改
vi /etc/config/autologin         # 编辑配置
/etc/init.d/autologin restart    # 应用配置
```

## 🔍 故障排查

### 问题 1: 服务无法启动

```bash
# 检查配置文件
cat /etc/config/autologin

# 手动运行测试
/usr/local/autologin/login.sh

# 查看系统日志
logread | tail -20
```

### 问题 2: 无法自动登录

```bash
# 查看详细日志
tail -n 100 /usr/local/autologin/logs/autologin.log

# 检查 WAN 接口
ifconfig
ip addr show

# 检查网络连通性
ping -c 3 10.10.11.11  # 认证服务器
```

### 问题 3: 找不到 WAN 接口

```bash
# 查看所有接口
ip addr show

# 查看 UCI 配置
uci show network.wan

# 手动指定
vi /etc/config/autologin
# 修改 WAN_INTERFACE 为正确的接口名
```

## 📚 文档导航

- **快速上手** → [QUICKSTART.md](QUICKSTART.md)
- **完整文档** → [README.md](README.md)
- **配置示例** → [config.example](config.example)

## 🧪 测试工具说明

运行 `test.sh` 可以检测：
- ✅ 系统环境（OpenWrt 版本）
- ✅ 依赖工具（wget、ping 等）
- ✅ 网络接口（自动识别 WAN）
- ✅ 网络连通性
- ✅ 登录接口（可选测试）
- ✅ 存储空间
- ✅ 配置建议

建议在正式安装前运行测试工具！

## 📦 安装后的文件位置

```
/etc/
├── config/
│   └── autologin                    # 配置文件（可编辑）
└── init.d/
    └── autologin                    # 服务脚本

/usr/local/autologin/
├── login.sh                         # 主程序
└── logs/                            # 日志目录
    ├── autologin.log                # 当前日志
    └── autologin.log.old            # 旧日志（轮转后）
```

## 🔧 高级配置

### 修改认证服务器地址

如果你的认证服务器不是 `10.10.11.11`：

```bash
vi /usr/local/autologin/login.sh
# 搜索 "10.10.11.11" 并替换为你的服务器地址

/etc/init.d/autologin restart
```

### 添加多个测试服务器

```bash
vi /usr/local/autologin/login.sh
# 找到 check_network 函数
# 修改: local test_hosts="119.29.29.29 223.5.5.5 8.8.8.8 114.114.114.114"

/etc/init.d/autologin restart
```

### 启用详细日志

```bash
vi /etc/config/autologin
# 临时启用 syslog 以便调试
LOG_TYPE="2"

/etc/init.d/autologin restart
logread -f | grep autologin  # 实时查看
```

## 🗑️ 卸载方法

**推荐：使用卸载脚本**
```bash
# 上传并运行卸载脚本
scp uninstall.sh root@192.168.1.1:/tmp/
ssh root@192.168.1.1 "chmod +x /tmp/uninstall.sh && /tmp/uninstall.sh"
```

**卸载脚本特性：**
- 🔍 智能检测安装状态（支持部分安装）
- 💾 可选配置备份（带时间戳）
- 🛑 安全停止所有服务和进程
- 🧹 完整清理所有文件和目录
- ✅ 验证卸载完整性
- 📊 详细的卸载报告

**手动卸载**
```bash
# 完整卸载
/etc/init.d/autologin stop
/etc/init.d/autologin disable
rm /etc/init.d/autologin
rm /etc/config/autologin
rm -rf /usr/local/autologin
pkill -9 -f autologin

# 确认删除
ls /etc/init.d/autologin        # 应该提示不存在
ls /usr/local/autologin         # 应该提示不存在
```

## 💡 使用技巧

1. **存储空间紧张?** → 使用 syslog 模式
2. **需要调试?** → 临时设置 10 秒检测频率
3. **网络稳定?** → 设置 60 秒检测频率，减少负载
4. **日志太多?** → 调小 LOG_SIZE_MB 或使用 syslog
5. **修改配置后** → 记得重启服务！

## 📝 变更历史

### v1.0.0 (2024)
- ✅ 初始版本
- ✅ 从手动脚本升级为自动化服务
- ✅ 添加完整的安装和测试工具
- ✅ 支持多种日志模式
- ✅ 自动获取 WAN 口 IP

## 📄 许可证

本项目仅供学习和个人使用。
使用者需遵守当地网络使用规定。

---

**需要帮助?**
- 📖 查看 [README.md](README.md) 获取详细文档
- ⚡ 查看 [QUICKSTART.md](QUICKSTART.md) 快速开始
- 🔧 运行 `test.sh` 诊断问题
